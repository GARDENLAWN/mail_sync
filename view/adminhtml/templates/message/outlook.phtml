<?php
/** @var \GardenLawn\MailSync\Block\Adminhtml\Message\Outlook $block */
$currentWebsiteId = $block->getCurrentWebsiteId();
?>
<style>
    /* Fallback styles in case Tailwind is not rebuilt yet */
    .mailsync-btn-primary {
        background: linear-gradient(to right, #2563eb, #1d4ed8) !important;
        color: white !important;
        border: none !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }
    .mailsync-btn-primary:hover {
        background: linear-gradient(to right, #1d4ed8, #1e40af) !important;
        transform: translateY(-2px);
    }

    .mailsync-btn-secondary {
        background-color: white !important;
        border: 1px solid #d1d5db !important;
        color: #374151 !important;
        border-radius: 9999px !important; /* Pill shape */
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
    }
    .mailsync-btn-secondary:hover {
        background-color: #f9fafb !important;
        border-color: #9ca3af !important;
        color: #111827 !important;
    }

    /* Fix for Magento admin buttons overriding */
    button.mailsync-btn-primary span, button.mailsync-btn-secondary span {
        color: inherit !important;
    }
</style>

<!-- Main Container -->
<div class="flex h-[calc(100vh-13rem)] bg-white border border-gray-300 rounded-xl shadow-lg overflow-hidden font-sans mt-4 text-gray-700" x-data="mailSyncApp()" x-init="init()">

    <!-- Left Sidebar: Folders -->
    <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col shrink-0">
        <div class="p-4">
            <button class="w-full mailsync-btn-primary !font-bold !py-3 !px-4 !rounded-lg !transition-all !duration-200 flex items-center justify-center gap-2" @click="composeEmail()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>New Message</span>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto px-3 pb-4 space-y-1">
            <template x-for="folder in folders" :key="folder.id">
                <div class="group flex items-center justify-between px-3 py-2.5 rounded-lg cursor-pointer text-sm transition-all duration-150 border border-transparent"
                     x-show="folder.message_count > 0"
                     :class="{
                        'bg-white text-blue-700 font-bold shadow-sm border-gray-200': activeFolderId === folder.id,
                        'text-gray-600 hover:bg-gray-200 hover:text-gray-900': activeFolderId !== folder.id
                     }"
                     :style="'padding-left: ' + (0.75 + (getFolderLevel(folder.path, folder.delimiter) * 1)) + 'rem'"
                     @click="selectFolder(folder.id)">

                    <div class="flex items-center truncate mr-2 flex-1 gap-3">
                        <div class="shrink-0 transition-colors" :class="activeFolderId === folder.id ? 'text-blue-600' : 'text-gray-400 group-hover:text-gray-600'" x-html="getFolderIcon(folder.name)"></div>
                        <span x-text="getFolderName(folder.name, folder.path, folder.delimiter)" class="truncate"></span>
                    </div>

                    <!-- Badge -->
                    <div class="px-2 py-0.5 rounded-md text-xs font-bold shrink-0 transition-colors"
                         :class="{
                            'bg-blue-100 text-blue-700': folder.unread_count > 0,
                            'text-gray-400 bg-gray-100 group-hover:bg-gray-300': folder.unread_count === 0
                         }">
                        <span x-show="folder.unread_count > 0" x-text="folder.unread_count"></span>
                        <span x-show="folder.unread_count === 0" x-text="folder.message_count"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Middle Column: Message List -->
    <div class="w-80 border-r border-gray-200 flex flex-col bg-white shrink-0">
        <div class="p-4 border-b border-gray-200 bg-white z-10">
            <div class="relative group">
                <input type="text"
                       placeholder="Search messages..."
                       class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all"
                       x-model="searchQuery"
                       @input.debounce.500ms="performSearch()">
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto" @scroll="handleScroll($event)">
            <template x-if="loadingMessages && messages.length === 0">
                <div class="p-8 text-center text-gray-400 text-sm flex flex-col items-center">
                    <svg class="animate-spin h-6 w-6 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading...
                </div>
            </template>

            <template x-for="msg in messages" :key="msg.id">
                <div class="p-4 border-b border-gray-100 cursor-pointer transition-all hover:bg-gray-50 relative group"
                     :class="{ 'bg-blue-50 hover:bg-blue-50': activeMessageId === msg.id }"
                     @click="selectMessage(msg.id)">

                    <!-- Active Indicator -->
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-600 rounded-r" x-show="activeMessageId === msg.id"></div>

                    <div class="flex justify-between items-baseline mb-1.5">
                        <span class="text-sm truncate pr-2"
                              :class="msg.status === 'unread' ? 'font-bold text-gray-900' : 'text-gray-700 font-medium'"
                              x-text="msg.sender"></span>
                        <span class="text-xs text-gray-400 shrink-0" x-text="formatDateShort(msg.date)"></span>
                    </div>
                    <div class="text-sm mb-1 truncate"
                         :class="msg.status === 'unread' ? 'font-bold text-gray-800' : 'text-gray-600'"
                         x-text="msg.subject"></div>
                    <div class="text-xs text-gray-500 truncate leading-relaxed" x-text="msg.preview"></div>
                </div>
            </template>

            <!-- Loading indicator at the bottom -->
            <template x-if="loadingMore">
                <div class="p-4 text-center text-xs text-gray-500">Loading more...</div>
            </template>

            <template x-if="!hasMoreMessages && messages.length > 0">
                <div class="p-4 text-center text-xs text-gray-400 border-t border-gray-100">End of list</div>
            </template>

            <template x-if="!loadingMessages && messages.length === 0">
                <div class="p-12 text-center text-gray-500 flex flex-col items-center">
                    <div class="text-5xl mb-4 opacity-20">ðŸ“­</div>
                    <p class="text-sm font-medium" x-text="searchQuery ? 'No messages found.' : 'Folder is empty.'"></p>
                </div>
            </template>
        </div>
    </div>

    <!-- Right Column: Message View -->
    <div class="flex-1 overflow-y-auto bg-white p-6 relative min-w-0">
        <template x-if="!activeMessage && !isComposing">
            <div class="h-full flex flex-col items-center justify-center text-gray-400">
                <div class="bg-gray-50 p-6 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 opacity-50 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <p class="text-lg font-medium text-gray-500">Select an item to read</p>
            </div>
        </template>

        <template x-if="loadingContent">
            <div class="h-full flex items-center justify-center text-gray-500">
                <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="font-medium">Loading content...</span>
            </div>
        </template>

        <template x-if="activeMessage && !loadingContent && !isComposing">
            <div class="w-full h-full flex flex-col">
                <!-- Header -->
                <div class="border-b border-gray-200 pb-6 mb-6 shrink-0">
                    <div class="flex justify-between items-start mb-5">
                        <h2 class="text-2xl font-bold text-gray-900 leading-tight" x-text="activeMessage.subject"></h2>
                        <div class="flex gap-2 shrink-0 ml-4">
                            <button class="text-gray-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors" @click="deleteMessage()" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-lg font-bold shadow-md shrink-0" x-text="getInitials(activeMessage.sender)"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-gray-900 text-lg truncate" x-text="activeMessage.sender"></div>
                            <div class="text-sm text-gray-500" x-text="formatDateFull(activeMessage.date)"></div>
                        </div>

                        <div class="flex gap-3 shrink-0 relative">
                            <button class="flex items-center gap-2 mailsync-btn-secondary !px-4 !py-2 !text-sm !font-semibold !transition-all !shadow-sm" @click="replyToMessage()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                </svg>
                                Reply
                            </button>

                            <!-- Move Dropdown -->
                            <div class="relative" @click.away="showMoveDropdown = false">
                                <button class="flex items-center gap-2 mailsync-btn-secondary !px-4 !py-2 !text-sm !font-semibold !transition-all !shadow-sm" @click="showMoveDropdown = !showMoveDropdown">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                    </svg>
                                    Move
                                </button>
                                <div class="absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-xl z-20 max-h-64 overflow-y-auto py-1" x-show="showMoveDropdown" style="display: none;">
                                    <template x-for="folder in folders" :key="folder.id">
                                        <div class="px-4 py-2.5 hover:bg-gray-50 cursor-pointer text-sm flex items-center gap-3 text-gray-700 transition-colors"
                                             x-show="folder.id !== activeFolderId"
                                             @click="moveMessage(folder.id)">
                                            <span class="text-gray-400 shrink-0" x-html="getFolderIcon(folder.name)"></span>
                                            <span class="truncate font-medium" x-text="folder.name"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Body -->
                <div class="flex-1 overflow-y-auto pr-2">
                    <div class="mb-8 w-full bg-white">
                        <iframe x-ref="messageFrame"
                                class="w-full border-none block"
                                style="min-height: 300px;"
                                frameborder="0"></iframe>
                    </div>

                    <!-- Inline Images -->
                    <template x-if="activeMessage.attachments && hasImageAttachments(activeMessage.attachments)">
                        <div class="mb-8 space-y-4">
                            <template x-for="att in getImageAttachments(activeMessage.attachments)" :key="att.id">
                                <div class="border border-gray-200 rounded-lg overflow-hidden inline-block max-w-full shadow-sm">
                                    <img :src="att.download_url" class="max-w-full h-auto block" :alt="att.filename" loading="lazy">
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Attachments -->
                    <template x-if="activeMessage.attachments && hasNonImageAttachments(activeMessage.attachments)">
                        <div class="border-t border-gray-200 pt-6 mt-6 pb-6">
                            <h4 class="mb-4 text-gray-500 uppercase text-xs font-bold tracking-wider flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                </svg>
                                Attachments
                            </h4>
                            <div class="flex flex-wrap gap-3">
                                <template x-for="att in getNonImageAttachments(activeMessage.attachments)" :key="att.id">
                                    <a :href="att.download_url" target="_blank" class="flex items-center px-4 py-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 hover:shadow-md transition-all text-gray-700 no-underline group">
                                        <span class="w-8 h-8 flex items-center justify-center rounded text-white font-bold text-[10px] mr-3 shrink-0 shadow-sm"
                                              :class="getFileTypeClass(att.filename, att.mime)"
                                              x-text="getFileExtension(att.filename)"></span>
                                        <div class="flex flex-col overflow-hidden">
                                            <span class="text-sm font-semibold truncate max-w-[200px] group-hover:text-blue-600 transition-colors" x-text="att.filename"></span>
                                            <span class="text-xs text-gray-400" x-text="formatSize(att.size)"></span>
                                        </div>
                                    </a>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Compose / Reply Mode -->
        <div class="h-full flex flex-col w-full" x-show="isComposing" style="display: none;">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100 shrink-0">
                <h3 class="text-2xl font-bold text-gray-800" x-text="activeMessageId ? 'Reply' : 'New Message'"></h3>
                <button @click="isComposing = false" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form @submit.prevent="sendMessage" class="flex-1 flex flex-col min-h-0">

                <div class="mb-4">
                    <label class="block mb-1.5 font-semibold text-gray-700 text-sm">To</label>
                    <input type="text" x-model="composeTo" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow shadow-sm" :readonly="!!activeMessageId">
                </div>

                <div class="mb-4">
                    <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Subject</label>
                    <input type="text" x-model="composeSubject" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow shadow-sm" :readonly="!!activeMessageId">
                </div>

                <div class="flex-1 mb-4 flex flex-col min-h-0">
                    <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Message</label>
                    <textarea x-model="composeBody" class="w-full flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow resize-none font-sans text-base leading-relaxed shadow-sm" placeholder="Type your message..."></textarea>
                </div>

                <div class="mb-6">
                    <label class="block mb-2 font-semibold text-gray-700 text-sm">Attachments</label>
                    <div class="flex items-center gap-4">
                        <label class="cursor-pointer inline-flex items-center gap-2 !px-4 !py-2 !border !border-gray-300 !rounded-full !text-sm !font-semibold !text-gray-700 !bg-white hover:!bg-gray-50 hover:!border-gray-400 !transition-all !shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                            <span>Add Files</span>
                            <input type="file" multiple @change="handleFileUpload($event)" class="hidden"/>
                        </label>
                        <span class="text-gray-400 text-sm italic" x-show="filesToUpload.length === 0">No files selected</span>
                    </div>

                    <!-- New Attachments Preview -->
                    <div class="mt-3 flex flex-wrap gap-3" x-show="filesToUpload.length > 0">
                        <template x-for="(file, index) in filesToUpload" :key="index">
                            <div class="flex items-center px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                                <span class="w-6 h-6 flex items-center justify-center rounded text-white font-bold text-[10px] mr-2"
                                      :class="getFileTypeClass(file.name, file.type)"
                                      x-text="getFileExtension(file.name)"></span>
                                <span class="text-sm text-gray-700 mr-2 font-medium" x-text="file.name"></span>
                                <span class="text-xs text-gray-400 mr-3" x-text="formatSize(file.size)"></span>
                                <button type="button" @click="removeFile(index)" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-200 flex justify-end gap-3">
                    <button type="button" class="mailsync-btn-secondary !px-5 !py-2.5 !text-sm !font-semibold !transition-all !shadow-sm" @click="isComposing = false">Cancel</button>
                    <button type="submit" class="mailsync-btn-primary !px-8 !py-2.5 !rounded-lg !text-sm !font-bold !transition-all !transform hover:!-translate-y-0.5 disabled:!opacity-50 disabled:!cursor-not-allowed" :disabled="sending">
                        <span x-show="!sending">Send Message</span>
                        <span x-show="sending">Sending...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    require(['Hyva_Admin/js/alpine'], function (Alpine) {
        'use strict';

        window.mailSyncApp = function() {
            return {
                folders: [],
                messages: [],
                activeFolderId: null,
                activeMessageId: null,
                activeMessage: null,
                searchQuery: '',
                loadingMessages: false,
                loadingContent: false,
                isComposing: false,
                composeTo: '',
                composeSubject: '',
                composeBody: '',
                filesToUpload: [],
                sending: false,
                showMoveDropdown: false,
                currentWebsiteId: <?= (int)$currentWebsiteId ?>,

                // Pagination state
                page: 1,
                limit: 20,
                hasMoreMessages: true,
                loadingMore: false,

                init() {
                    this.fetchFolders();
                },

                fetchFolders() {
                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/folders') ?>?website_id=' + this.currentWebsiteId)
                        .then(r => r.json())
                        .then(data => {
                            this.folders = data;
                            if (this.folders.length > 0) {
                                // Try to find INBOX or first available folder with messages
                                let defaultFolder = this.folders.find(f => f.name.toUpperCase() === 'INBOX' && f.message_count > 0);
                                if (!defaultFolder) {
                                    defaultFolder = this.folders.find(f => f.message_count > 0);
                                }

                                if (defaultFolder) {
                                    this.selectFolder(defaultFolder.id);
                                } else if (this.folders.length > 0) {
                                    // Fallback if all empty, just select first one (even if hidden)
                                    this.selectFolder(this.folders[0].id);
                                }
                            } else {
                                // No folders found for this website
                                this.messages = [];
                            }
                        });
                },

                selectFolder(id) {
                    this.activeFolderId = id;
                    this.activeMessageId = null;
                    this.activeMessage = null;
                    this.isComposing = false;
                    this.searchQuery = ''; // Clear search on folder change
                    this.resetAndFetchMessages();
                },

                performSearch() {
                    // Triggered by @input.debounce
                    this.resetAndFetchMessages();
                },

                resetAndFetchMessages() {
                    this.loadingMessages = true;
                    this.messages = [];
                    this.page = 1;
                    this.hasMoreMessages = true;

                    this.fetchMessages(this.activeFolderId, this.page, this.searchQuery).then(data => {
                        this.messages = data;
                        this.loadingMessages = false;
                        if (data.length < this.limit) {
                            this.hasMoreMessages = false;
                        }
                    });
                },

                fetchMessages(folderId, page, search = '') {
                    if (!folderId) return Promise.resolve([]);

                    let url = '<?= $block->getUrl('gardenlawn_mailsync/api/messages') ?>?folder_id=' + folderId + '&page=' + page + '&limit=' + this.limit;
                    if (search) {
                        url += '&search=' + encodeURIComponent(search);
                    }
                    return fetch(url).then(r => r.json());
                },

                handleScroll(event) {
                    const el = event.target;
                    // Check if scrolled near bottom (within 50px)
                    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 50) {
                        this.loadMoreMessages();
                    }
                },

                loadMoreMessages() {
                    if (this.loadingMore || !this.hasMoreMessages || !this.activeFolderId) return;

                    this.loadingMore = true;
                    this.page++;

                    this.fetchMessages(this.activeFolderId, this.page, this.searchQuery).then(data => {
                        if (data.length > 0) {
                            // Append new messages
                            this.messages = [...this.messages, ...data];
                            if (data.length < this.limit) {
                                this.hasMoreMessages = false;
                            }
                        } else {
                            this.hasMoreMessages = false;
                        }
                        this.loadingMore = false;
                    });
                },

                selectMessage(id) {
                    this.activeMessageId = id;
                    this.isComposing = false;
                    this.loadingContent = true;

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/message') ?>?id=' + id)
                        .then(r => r.json())
                        .then(data => {
                            this.activeMessage = data;
                            this.loadingContent = false;

                            // Render content in iframe after data is loaded and DOM is updated
                            this.$nextTick(() => {
                                this.renderIframeContent();
                            });
                        });
                },

                renderIframeContent() {
                    const frame = this.$refs.messageFrame;
                    if (!frame || !this.activeMessage) return;

                    const content = this.processContent(this.activeMessage.content, this.activeMessage.attachments);
                    const doc = frame.contentWindow.document;

                    // Basic styles to make email look decent inside iframe
                    const html = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <style>
                                body {
                                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                                    margin: 0;
                                    padding: 0;
                                    word-wrap: break-word;
                                    color: #333;
                                    font-size: 14px;
                                    line-height: 1.5;
                                }
                                img { max-width: 100%; height: auto; }
                                blockquote { margin: 1em 0; border-left: 4px solid #ddd; padding-left: 1em; color: #666; }
                                a { color: #007bdb; }
                            </style>
                        </head>
                        <body>${content}</body>
                        </html>
                    `;

                    doc.open();
                    doc.write(html);
                    doc.close();

                    // Auto-resize iframe height
                    const resizeIframe = () => {
                        if(frame && frame.contentWindow) {
                            frame.style.height = '0px'; // Reset to shrink if needed
                            frame.style.height = (frame.contentWindow.document.body.scrollHeight + 20) + 'px';
                        }
                    };

                    // Resize immediately
                    resizeIframe();

                    // Resize again after images load (simple delay approach + load listener)
                    setTimeout(resizeIframe, 500);

                    // Add load listener to images inside iframe
                    const images = doc.getElementsByTagName('img');
                    for (let i = 0; i < images.length; i++) {
                        images[i].onload = resizeIframe;
                    }
                },

                replyToMessage() {
                    this.composeTo = this.activeMessage.sender;
                    this.composeSubject = 'Re: ' + this.activeMessage.subject;
                    this.composeBody = '';
                    this.filesToUpload = [];
                    this.isComposing = true;
                },

                composeEmail() {
                    this.activeMessageId = null;
                    this.activeMessage = null;
                    this.composeTo = '';
                    this.composeSubject = '';
                    this.composeBody = '';
                    this.filesToUpload = [];
                    this.isComposing = true;
                },

                handleFileUpload(event) {
                    const files = event.target.files;
                    for (let i = 0; i < files.length; i++) {
                        this.filesToUpload.push(files[i]);
                    }
                    event.target.value = '';
                },

                removeFile(index) {
                    this.filesToUpload.splice(index, 1);
                },

                sendMessage() {
                    this.sending = true;
                    const formData = new FormData();
                    formData.append('form_key', '<?= $block->getFormKey() ?>');
                    formData.append('website_id', this.currentWebsiteId); // Pass website_id

                    if (this.activeMessageId) {
                        formData.append('id', this.activeMessageId);
                    }

                    formData.append('to', this.composeTo);
                    formData.append('subject', this.composeSubject);
                    formData.append('reply_body', this.composeBody);

                    for (let i = 0; i < this.filesToUpload.length; i++) {
                        formData.append('reply_attachment[]', this.filesToUpload[i]);
                    }

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/message/send') ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error sending message');
                        this.sending = false;
                    });
                },

                moveMessage(targetFolderId) {
                    if (!confirm('Are you sure you want to move this message?')) return;

                    this.showMoveDropdown = false;
                    this.loadingContent = true;

                    const formData = new FormData();
                    formData.append('form_key', '<?= $block->getFormKey() ?>');
                    formData.append('message_id', this.activeMessageId);
                    formData.append('folder_id', targetFolderId);

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/move') ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            this.messages = this.messages.filter(m => m.id !== this.activeMessageId);
                            this.activeMessageId = null;
                            this.activeMessage = null;
                            this.loadingContent = false;
                            // Refresh folders to update counts
                            this.fetchFolders();
                        } else {
                            alert('Error moving message: ' + (data.error || 'Unknown error'));
                            this.loadingContent = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error moving message');
                        this.loadingContent = false;
                    });
                },

                deleteMessage() {
                    if (!confirm('Are you sure you want to delete this message?')) return;

                    this.loadingContent = true;

                    const formData = new FormData();
                    formData.append('form_key', '<?= $block->getFormKey() ?>');
                    formData.append('message_id', this.activeMessageId);

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/delete') ?>', {
                        method: 'POST',
                        body: formData
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            this.messages = this.messages.filter(m => m.id !== this.activeMessageId);
                            this.activeMessageId = null;
                            this.activeMessage = null;
                            this.loadingContent = false;
                            // Refresh folders to update counts
                            this.fetchFolders();
                        } else {
                            alert('Error deleting message: ' + (data.error || 'Unknown error'));
                            this.loadingContent = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error deleting message');
                        this.loadingContent = false;
                    });
                },

                formatDate(dateStr) {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },

                formatDateShort(dateStr) {
                    const d = new Date(dateStr);
                    const now = new Date();
                    if (d.toDateString() === now.toDateString()) {
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                    return d.toLocaleDateString();
                },

                formatDateFull(dateStr) {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + ' at ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },

                getInitials(name) {
                    return name ? name.charAt(0).toUpperCase() : '?';
                },

                formatSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                getFileExtension(filename) {
                    return filename.split('.').pop().toUpperCase().substring(0, 3);
                },

                isImage(filename, mime) {
                    const ext = filename.split('.').pop().toLowerCase();
                    return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext) || (mime && mime.startsWith('image/'));
                },

                getFileTypeClass(filename, mime) {
                    const ext = filename.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) return 'bg-red-500';
                    if (this.isImage(filename, mime)) return 'bg-blue-500';
                    if (['doc', 'docx', 'rtf'].includes(ext)) return 'bg-blue-600';
                    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'bg-green-600';
                    if (['ppt', 'pptx'].includes(ext)) return 'bg-orange-500';
                    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'bg-yellow-400 text-gray-800';
                    if (['php', 'js', 'css', 'html', 'xml', 'json'].includes(ext)) return 'bg-gray-700';
                    if (['txt', 'md'].includes(ext)) return 'bg-gray-400';
                    return 'bg-gray-500';
                },

                hasImageAttachments(attachments) {
                    if (!attachments) return false;
                    // Only show images that are NOT inline
                    return attachments.some(att => this.isImage(att.filename, att.mime) && !att.content_id);
                },

                getImageAttachments(attachments) {
                    if (!attachments) return [];
                    // Only show images that are NOT inline
                    return attachments.filter(att => this.isImage(att.filename, att.mime) && !att.content_id);
                },

                getNonImageAttachments(attachments) {
                    if (!attachments) return [];
                    // Show everything that is NOT an image (inline or not, usually docs are not inline in this context)
                    // Or strictly: not image OR (image AND inline but failed to render? no, keep simple)
                    return attachments.filter(att => !this.isImage(att.filename, att.mime));
                },

                hasNonImageAttachments(attachments) {
                    if (!attachments) return false;
                    return attachments.some(att => !this.isImage(att.filename, att.mime));
                },

                processContent(content, attachments) {
                    if (!content) return '';
                    if (!attachments || attachments.length === 0) return content;

                    let processedContent = content;
                    attachments.forEach(att => {
                        if (att.content_id) {
                            // Clean CID (remove < >)
                            const cid = att.content_id.replace(/^<|>$/g, '');
                            // Replace all occurrences of cid:CID with the download URL
                            // Handle both cid:CID and cid:CID@domain
                            const regex = new RegExp('cid:' + cid.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                            processedContent = processedContent.replace(regex, att.download_url);
                        }
                    });
                    return processedContent;
                },

                getFolderLevel(path, delimiter) {
                    if (!delimiter) delimiter = '/';
                    // Count occurrences of delimiter in path
                    // Example: "INBOX.Archive" with delimiter "." -> level 1
                    // "INBOX" -> level 0
                    return (path.match(new RegExp('\\' + (delimiter === '.' ? '\\.' : delimiter), 'g')) || []).length;
                },

                getFolderName(name, path, delimiter) {
                    if (!delimiter) delimiter = '/';
                    // If name is already short (e.g. "Archive"), return it.
                    // If name is full path (e.g. "INBOX.Archive"), split it.
                    // Usually IMAP returns full path in 'name' or 'path' depending on server.
                    // We use 'path' for hierarchy calculation, but 'name' for display.
                    // Let's try to split 'name' just in case.

                    if (name.includes(delimiter)) {
                        return name.split(delimiter).pop();
                    }
                    return name;
                },

                getFolderIcon(name) {
                    const lowerName = name.toLowerCase();
                    // Inbox
                    if (lowerName.includes('inbox') || lowerName.includes('odebrane')) {
                        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>`;
                    }
                    // Sent
                    if (lowerName.includes('sent') || lowerName.includes('wysÅ‚ane')) {
                        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`;
                    }
                    // Trash
                    if (lowerName.includes('trash') || lowerName.includes('bin') || lowerName.includes('kosz') || lowerName.includes('deleted')) {
                        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                    }
                    // Drafts
                    if (lowerName.includes('draft') || lowerName.includes('szkice')) {
                        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>`;
                    }
                    // Spam
                    if (lowerName.includes('spam') || lowerName.includes('junk')) {
                        return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
                    }
                    // Default Folder
                    return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`;
                }
            }
        }

        if (typeof Alpine === 'object' && !window.Alpine) {
            window.Alpine = Alpine;
        }
    });
</script>
