<?php
/** @var \Magento\Backend\Block\Template $block */
?>
<div class="mailsync-outlook" x-data="mailSyncApp()" x-init="init()">

    <!-- Left Sidebar: Folders -->
    <div class="mailsync-sidebar">
        <div class="mailsync-sidebar-header p-4">
            <button class="action-btn primary w-full" @click="composeEmail()">
                <span>New Message</span>
            </button>
        </div>
        <div class="mailsync-folders-list flex-1 overflow-y-auto">
            <template x-for="folder in folders" :key="folder.id">
                <div class="mailsync-folder-item"
                     :class="{ 'active': activeFolderId === folder.id }"
                     @click="selectFolder(folder.id)">
                    <span class="folder-icon">üìÅ</span>
                    <span x-text="folder.name"></span>
                </div>
            </template>
        </div>
    </div>

    <!-- Middle Column: Message List -->
    <div class="mailsync-message-list w-[350px] border-r border-gray-200 flex flex-col bg-white">
        <div class="mailsync-list-header p-4 border-b border-gray-200">
            <input type="text" placeholder="Search..." class="admin__control-text w-full" x-model="searchQuery">
        </div>
        <div class="mailsync-list-content flex-1 overflow-y-auto">
            <template x-if="loadingMessages">
                <div class="p-4 text-center">Loading...</div>
            </template>
            <template x-for="msg in filteredMessages" :key="msg.id">
                <div class="mailsync-message-item p-5 border-b border-gray-100 cursor-pointer transition-colors hover:bg-gray-50"
                     :class="{ 'active bg-blue-50 border-l-4 border-blue-500': activeMessageId === msg.id, 'unread': msg.status === 'unread' }"
                     @click="selectMessage(msg.id)">
                    <div class="msg-sender text-sm text-gray-800 mb-1 truncate" x-text="msg.sender"></div>
                    <div class="msg-subject text-sm text-gray-600 mb-1" :class="{ 'font-bold text-black': msg.status === 'unread' }" x-text="msg.subject"></div>
                    <div class="msg-preview text-xs text-gray-500 truncate" x-text="msg.preview"></div>
                    <div class="msg-date text-xs text-gray-400 text-right mt-2" x-text="formatDate(msg.date)"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- Right Column: Message View -->
    <div class="mailsync-message-view flex-1 overflow-y-auto bg-white p-8 relative">
        <template x-if="!activeMessage && !isComposing">
            <div class="empty-state flex flex-col items-center justify-center h-full text-gray-400">
                <div class="empty-icon text-6xl mb-4">‚úâÔ∏è</div>
                <p>Select an item to read</p>
            </div>
        </template>

        <template x-if="loadingContent">
            <div class="p-8 text-center">Loading content...</div>
        </template>

        <template x-if="activeMessage && !loadingContent && !isComposing">
            <div class="message-detail">
                <div class="message-header mb-8 border-b border-gray-200 pb-6">
                    <h2 class="text-2xl mb-6 text-gray-800" x-text="activeMessage.subject"></h2>
                    <div class="message-meta flex items-center gap-6">
                        <div class="sender-avatar w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-xl font-bold" x-text="getInitials(activeMessage.sender)"></div>
                        <div class="meta-info flex-1">
                            <div class="sender-name font-bold text-lg text-gray-800" x-text="activeMessage.sender"></div>
                            <div class="message-date text-gray-500 text-sm" x-text="activeMessage.date"></div>
                        </div>
                        <div class="message-actions">
                            <button class="action-btn secondary" @click="replyToMessage()">Reply</button>
                        </div>
                    </div>
                </div>

                <div class="message-body text-base leading-relaxed text-gray-700 mb-12" x-html="activeMessage.content"></div>

                <template x-if="activeMessage.attachments && activeMessage.attachments.length > 0">
                    <div class="message-attachments border-t border-gray-200 pt-6">
                        <h4 class="mb-4 text-gray-600 uppercase text-xs font-bold tracking-wide">Attachments</h4>
                        <div class="attachments-grid flex flex-wrap gap-4">
                            <template x-for="att in activeMessage.attachments" :key="att.id">
                                <a :href="att.download_url" target="_blank" class="attachment-card flex items-center px-4 py-3 bg-gray-100 border border-gray-300 rounded no-underline text-gray-800 hover:bg-gray-200">
                                    <span class="att-icon mr-3">üìé</span>
                                    <span class="att-name" x-text="att.filename"></span>
                                    <span class="att-size text-gray-500 ml-2 text-sm" x-text="formatSize(att.size)"></span>
                                </a>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Compose / Reply Mode -->
        <div class="compose-view bg-white h-full flex flex-col" x-show="isComposing" style="display: none;">
            <h3 class="text-xl mb-6" x-text="activeMessageId ? 'Reply' : 'New Message'"></h3>
            <form id="reply-form" action="<?= $block->getUrl('gardenlawn_mailsync/message/send') ?>" method="post" enctype="multipart/form-data" class="flex-1 flex flex-col">
                <input name="form_key" type="hidden" value="<?= $block->getFormKey() ?>" />
                <input name="id" type="hidden" :value="activeMessageId" />

                <div class="field mb-4">
                    <label class="block mb-2 font-bold text-gray-700">To:</label>
                    <input type="text" name="to" class="admin__control-text w-full p-2" x-model="composeTo" :readonly="!!activeMessageId">
                </div>

                <div class="field mb-4">
                    <label class="block mb-2 font-bold text-gray-700">Subject:</label>
                    <input type="text" name="subject" class="admin__control-text w-full p-2" x-model="composeSubject" :readonly="!!activeMessageId">
                </div>

                <div class="field flex-1 mb-4">
                    <label class="block mb-2 font-bold text-gray-700">Message:</label>
                    <textarea name="reply_body" class="admin__control-textarea w-full h-full p-4 min-h-[400px]" placeholder="Type your message..."></textarea>
                </div>

                <div class="field mb-6">
                    <label class="block mb-2 font-bold text-gray-700">Attachments:</label>
                    <input type="file" name="reply_attachment[]" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>

                <div class="actions pt-4 border-t border-gray-200 flex justify-end gap-3">
                    <button type="button" class="action-btn secondary" @click="isComposing = false">Cancel</button>
                    <button type="submit" class="action-btn primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    require(['Hyva_Admin/js/alpine'], function (Alpine) {
        'use strict';

        window.mailSyncApp = function() {
            return {
                folders: [],
                messages: [],
                activeFolderId: null,
                activeMessageId: null,
                activeMessage: null,
                searchQuery: '',
                loadingMessages: false,
                loadingContent: false,
                isComposing: false,
                composeTo: '',
                composeSubject: '',

                init() {
                    this.fetchFolders();
                },

                fetchFolders() {
                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/folders') ?>')
                        .then(r => r.json())
                        .then(data => {
                            this.folders = data;
                            if (this.folders.length > 0) {
                                // Try to find INBOX
                                const inbox = this.folders.find(f => f.name.toUpperCase() === 'INBOX');
                                this.selectFolder(inbox ? inbox.id : this.folders[0].id);
                            }
                        });
                },

                selectFolder(id) {
                    this.activeFolderId = id;
                    this.activeMessageId = null;
                    this.activeMessage = null;
                    this.isComposing = false;
                    this.loadingMessages = true;

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/messages') ?>?folder_id=' + id)
                        .then(r => r.json())
                        .then(data => {
                            this.messages = data;
                            this.loadingMessages = false;
                        });
                },

                selectMessage(id) {
                    this.activeMessageId = id;
                    this.isComposing = false;
                    this.loadingContent = true;

                    fetch('<?= $block->getUrl('gardenlawn_mailsync/api/message') ?>?id=' + id)
                        .then(r => r.json())
                        .then(data => {
                            this.activeMessage = data;
                            this.loadingContent = false;
                        });
                },

                replyToMessage() {
                    this.composeTo = this.activeMessage.sender;
                    this.composeSubject = 'Re: ' + this.activeMessage.subject;
                    this.isComposing = true;
                },

                composeEmail() {
                    this.activeMessageId = null;
                    this.activeMessage = null;
                    this.composeTo = '';
                    this.composeSubject = '';
                    this.isComposing = true;
                },

                get filteredMessages() {
                    if (!this.searchQuery) return this.messages;
                    const q = this.searchQuery.toLowerCase();
                    return this.messages.filter(m =>
                        m.subject.toLowerCase().includes(q) ||
                        m.sender.toLowerCase().includes(q)
                    );
                },

                formatDate(dateStr) {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },

                getInitials(name) {
                    return name ? name.charAt(0).toUpperCase() : '?';
                },

                formatSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                getFileExtension(filename) {
                    return filename.split('.').pop().toUpperCase().substring(0, 3);
                },

                getFileTypeClass(filename, mime) {
                    const ext = filename.split('.').pop().toLowerCase();
                    if (['pdf'].includes(ext)) return 'type-pdf';
                    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext) || mime.startsWith('image/')) return 'type-image';
                    if (['doc', 'docx', 'rtf'].includes(ext)) return 'type-word';
                    if (['xls', 'xlsx', 'csv'].includes(ext)) return 'type-excel';
                    if (['ppt', 'pptx'].includes(ext)) return 'type-powerpoint';
                    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'type-archive';
                    if (['php', 'js', 'css', 'html', 'xml', 'json'].includes(ext)) return 'type-code';
                    if (['txt', 'md'].includes(ext)) return 'type-text';
                    return 'type-default';
                }
            }
        }

        if (typeof Alpine === 'object' && !window.Alpine) {
            window.Alpine = Alpine;
        }
    });
</script>
